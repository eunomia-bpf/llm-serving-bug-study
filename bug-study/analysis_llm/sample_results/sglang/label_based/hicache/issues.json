[
  {
    "number": 5372,
    "title": "[Bug] hierarchical_cache oom",
    "body": "### Checklist\n\n- [x] 1. I have searched related issues but cannot get the expected help.\n- [x] 2. The bug has not been fixed in the latest version.\n- [x] 3. Please note that if the bug-related issue you submitted lacks corresponding environment info and a minimal reproducible demo, it will be challenging for us to reproduce and resolve the issue, reducing the likelihood of receiving feedback.\n- [x] 4. If the issue you raised is not a bug but a question, please raise a discussion at https://github.com/sgl-project/sglang/discussions/new/choose Otherwise, it will be closed.\n- [x] 5. Please use English, otherwise it will be closed.\n\n### Describe the bug\n\nhi~ @xiezhq-hermann You are the main contributor to hierarchical cache, thank you for your great work\uff01  I have a few questions about hierarchical cache, I'm very confused so I'm looking for your help.\n\nRecently we want to try to use hierarchical cache, before that, for DeepSeek R1 , our online args `--mem-fraction-static` is 0.95.\n\n- When I try to launch sglang server with args `--mem-fraction-static=0.95`, `--enable-hierarchical-cache`, `--hicache-ratio=2` , OOM occurs before the server is successfully started\n-  with args `--mem-fraction-static=0.94`, `--enable-hierarchical-cache`, `--hicache-ratio=2` , sglang server is successfully started  but OOM occurs while running the benchmark.\n- with args `--mem-fraction-static=0.93`, `--enable-hierarchical-cache`, `--hicache-ratio=10` , OOM occurs while running the benchmark\n\nSo I can only reduce `--mem-fraction-static` to 0.93.  Based on 0.93, I tried to set different `--hicache-ratio` values, and I found that the memory usage of GPU0 device was significantly higher than that of other devices. which is the main cause of OOM. The following figure was taken after sglang server was successfully started and before running the benchmark.\n\n<img width=\"879\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/13fdbd60-7b9d-4432-961c-16b0986ba56b\" />\n\nI debugged the hierarchical cache code and found that HiCacheController used multi stream to read and write CPU cache. When I disabled multi stream with [code](https://github.com/sgl-project/sglang/compare/main...AniZpZ:sglang:disable_hicache_multi_stream), The phenomenon that GPU0 device has higher memory usage than other devices has disappeared. At this point I can even launch sglang server with args `--mem-fraction-static=0.95`, `--enable-hierarchical-cache`, `--hicache-ratio 13`, the server can be started successfully, but it will oom when running the benchmark. I found that the oom probably occurs when the cache is loaded from the CPU to GPU for the first time. I will confirm this.\n\nI have a few questions:\n\n- Why does multi stream cause GPU0 to occupy more GPU memory?\n- Why does gpu0 need more memory, but other gpus don't?\n- Why does the additional memory usage of gpu0 vary with different `--hicache-ratio`\uff1fHicache-ratio is just the ratio of CPU: GPU cache. As far as I understand, it has no direct connection with GPU memory.\n\n\nFor DeepSeek R1 , reducing `--mem-fraction-static` to 0.93  has a significant impact on throughput. Because the number of GPU tokens is reduced by 23%, if the hit rate of the CPU cache is not high, there will be no benefit at all.  `max_total_num_tokens` Data are as follows\uff1a\n\n<img width=\"479\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/6daaf010-6161-4b12-bdb8-ba7b878d1549\" />\n\nI wonder if it is possible to turn on hierarchical cache without affecting throughput too much.\n\nThank you very much\uff01\n\n### Reproduction\n\n\npython -m sglang.launch_server --host 0.0.0.0 --dtype auto --mem-fraction-static 0.93 --tp-size 8 --chat-template /path/to/r1.jinja --max-running-requests 48 --trust-remote-code --enable-cache-report --log-level info --chunked-prefill-size 4096 --context-length 65536 --quantization fp8 --enable-torch-compile --cuda-graph-max-bs 64 --torch-compile-max-bs 36 --enable-flashinfer-mla --enable-mixed-chunk --model-path /path/to/DeepSeek-R1 --port 8188 --enable-hierarchical-cache --hicache-ratio 2\n\n\n### Environment\n\nPython: 3.10.13 (main, Sep 11 2023, 13:44:35) [GCC 11.2.0]\nCUDA available: True\nGPU 0,1,2,3,4,5,6,7: NVIDIA H20\nGPU 0,1,2,3,4,5,6,7 Compute Capability: 9.0\nCUDA_HOME: /usr/local/cuda\nNVCC: Cuda compilation tools, release 12.4, V12.4.131\nCUDA Driver Version: 535.183.06\nPyTorch: 2.5.1+cu124\nsglang: 0.4.5\nsgl_kernel: 0.0.8\nflashinfer: Module Not Found\ntriton: 3.1.0\ntransformers: 4.51.0\ntorchao: 0.9.0\nnumpy: 1.26.4\naiohttp: 3.11.10\nfastapi: 0.115.6\nhf_transfer: 0.1.9\nhuggingface_hub: 0.30.2\ninteregular: 0.3.3\nmodelscope: 1.23.1\norjson: 3.10.12\noutlines: 0.1.11\npackaging: 24.2\npsutil: 6.1.0\npydantic: 2.10.6\nmultipart: Module Not Found\nzmq: Module Not Found\nuvicorn: 0.32.1\nuvloop: 0.21.0\nvllm: 0.7.2\nxgrammar: 0.1.17\nopenai: 1.65.2\ntiktoken: 0.9.0\nanthropic: 0.49.0\nlitellm: 1.62.1\ndecord: 0.6.0\nNVIDIA Topology: \n        GPU0    GPU1    GPU2    GPU3    GPU4    GPU5    GPU6    GPU7    NIC0    NIC1    NIC2   NIC3    CPU Affinity    NUMA Affinity   GPU NUMA ID\nGPU0     X      NV18    NV18    NV18    NV18    NV18    NV18    NV18    NODE    NODE    SYS   SYS     0-47,96-143     0               N/A\nGPU1    NV18     X      NV18    NV18    NV18    NV18    NV18    NV18    PIX     NODE    SYS   SYS     0-47,96-143     0               N/A\nGPU2    NV18    NV18     X      NV18    NV18    NV18    NV18    NV18    NODE    NODE    SYS   SYS     0-47,96-143     0               N/A\nGPU3    NV18    NV18    NV18     X      NV18    NV18    NV18    NV18    NODE    PIX     SYS   SYS     0-47,96-143     0               N/A\nGPU4    NV18    NV18    NV18    NV18     X      NV18    NV18    NV18    SYS     SYS     PIX   NODE    48-95,144-191   1               N/A\nGPU5    NV18    NV18    NV18    NV18    NV18     X      NV18    NV18    SYS     SYS     NODE   NODE    48-95,144-191   1               N/A\nGPU6    NV18    NV18    NV18    NV18    NV18    NV18     X      NV18    SYS     SYS     NODE   PIX     48-95,144-191   1               N/A\nGPU7    NV18    NV18    NV18    NV18    NV18    NV18    NV18     X      SYS     SYS     NODE   NODE    48-95,144-191   1               N/A\nNIC0    NODE    PIX     NODE    NODE    SYS     SYS     SYS     SYS      X      NODE    SYS   SYS\nNIC1    NODE    NODE    NODE    PIX     SYS     SYS     SYS     SYS     NODE     X      SYS   SYS\nNIC2    SYS     SYS     SYS     SYS     PIX     NODE    NODE    NODE    SYS     SYS      X    NODE\nNIC3    SYS     SYS     SYS     SYS     NODE    NODE    PIX     NODE    SYS     SYS     NODE    X \n\nLegend:\n\n  X    = Self\n  SYS  = Connection traversing PCIe as well as the SMP interconnect between NUMA nodes (e.g., QPI/UPI)\n  NODE = Connection traversing PCIe as well as the interconnect between PCIe Host Bridges within a NUMA node\n  PHB  = Connection traversing PCIe as well as a PCIe Host Bridge (typically the CPU)\n  PXB  = Connection traversing multiple PCIe bridges (without traversing the PCIe Host Bridge)\n  PIX  = Connection traversing at most a single PCIe bridge\n  NV#  = Connection traversing a bonded set of # NVLinks\n\nNIC Legend:\n\n  NIC0: mlx5_bond_0\n  NIC1: mlx5_bond_1\n  NIC2: mlx5_bond_2\n  NIC3: mlx5_bond_3\n\n\nulimit soft: 1048576",
    "labels": [
      "hicache"
    ],
    "state": "closed",
    "created_at": "2025-04-14T09:26:57+00:00",
    "closed_at": "2025-04-21T18:46:48+00:00",
    "comments": 5,
    "reactions": {
      "url": "https://api.github.com/repos/sgl-project/sglang/issues/5372/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 1
    },
    "author_association": "CONTRIBUTOR",
    "html_url": "https://github.com/sgl-project/sglang/issues/5372"
  }
]